// dashboard-router.js - Manejo de redirecci√≥n despu√©s del login
class DashboardRouter {
    constructor() {
        this.authChecked = false;
        this.currentPath = window.location.pathname;
        this.init();
    }

    init() {
        console.log('üîÑ DashboardRouter inicializando...');
        console.log('üìÑ P√°gina actual:', this.currentPath);
        console.log('üîç Es dashboard:', this.isDashboardPage());
        console.log('üîç Es login:', this.isLoginPage());
        
        // ‚úÖ SOLO verificar autenticaci√≥n en p√°ginas de dashboard
        if (this.isDashboardPage()) {
            console.log('üîê Verificando autenticaci√≥n en dashboard...');
            this.checkAuthentication();
        } else if (this.isLoginPage()) {
            console.log('üîê En p√°gina de login, verificando si ya est√° autenticado...');
            this.checkIfAlreadyAuthenticated();
        } else {
            console.log('‚ÑπÔ∏è No es dashboard ni login, no se verifica autenticaci√≥n');
        }
    }

    isLoginPage() {
        return this.currentPath === '/login/' || 
               this.currentPath.includes('login.html') || 
               this.currentPath === '/api/login/' ||
               this.currentPath === '/login';
    }

    isDashboardPage() {
        return this.currentPath.includes('dashboard') || 
               this.currentPath.startsWith('/api/dashboard-') ||
               this.currentPath === '/api/dashboard-admin/' ||
               this.currentPath === '/api/dashboard-residente/' ||
               this.currentPath === '/api/dashboard-guardia/' ||
               this.currentPath === '/api/dashboard-tecnico/' ||
               this.currentPath === '/api/dashboard-visitante/' ||
               this.currentPath === '/dashboard-admin/' ||
               this.currentPath === '/dashboard-residente/' ||
               this.currentPath === '/dashboard-guardia/' ||
               this.currentPath === '/dashboard-tecnico/' ||
               this.currentPath === '/dashboard-visitante/';
    }

    checkIfAlreadyAuthenticated() {
        const token = localStorage.getItem('authToken');
        const userRole = localStorage.getItem('userRole');
        
        if (token && userRole && this.isValidToken(token) && this.isValidRole(userRole)) {
            console.log('‚úÖ Usuario ya autenticado, redirigiendo a dashboard...');
            this.redirectToDashboard(userRole);
            return true;
        }
        return false;
    }

    checkAuthentication() {
        if (this.authChecked) {
            console.log('‚úÖ Autenticaci√≥n ya verificada');
            return true;
        }
        
        const token = localStorage.getItem('authToken');
        const userRole = localStorage.getItem('userRole');
        
        console.log('üîç VERIFICANDO AUTENTICACI√ìN:');
        console.log('  - Token:', token ? '‚úÖ Existe' : '‚ùå No existe');
        console.log('  - Rol:', userRole);
        console.log('  - P√°gina actual:', this.currentPath);
        
        // ‚úÖ CR√çTICO: Si no hay token en un dashboard, redirigir a login
        if (!token) {
            console.log('‚ùå NO HAY TOKEN en dashboard, redirigiendo a login...');
            this.redirectToLogin();
            return false;
        }

        // ‚úÖ Verificar formato del token
        if (!this.isValidToken(token)) {
            console.log('‚ùå Token inv√°lido, redirigiendo a login...');
            this.redirectToLogin();
            return false;
        }

        // ‚úÖ Verificar rol v√°lido
        if (!this.isValidRole(userRole)) {
            console.log('‚ùå Rol inv√°lido:', userRole);
            this.redirectToLogin();
            return false;
        }

        this.authChecked = true;
        console.log('‚úÖ AUTENTICACI√ìN EXITOSA - Usuario puede acceder al dashboard');
        return true;
    }

    isValidToken(token) {
        if (!token || token === 'undefined' || token === 'null') {
            return false;
        }

        try {
            // Para tokens UUID (generados por el backend)
            if (token.includes('-') && token.length === 36) {
                console.log('‚úÖ Token UUID v√°lido');
                return true;
            }

            // Para tokens simples base64
            try {
                const tokenData = JSON.parse(atob(token));
                console.log('‚úÖ Token base64 v√°lido:', tokenData);
                
                // Verificar expiraci√≥n (24 horas)
                if (tokenData.timestamp) {
                    const tokenTime = parseInt(tokenData.timestamp);
                    const currentTime = Date.now();
                    const hoursDiff = (currentTime - tokenTime) / (1000 * 60 * 60);
                    
                    if (hoursDiff > 24) {
                        console.log('‚ùå Token expirado:', hoursDiff.toFixed(2) + ' horas');
                        return false;
                    }
                }
                
                return true;
            } catch (parseError) {
                console.log('‚úÖ Token con formato simple, permitiendo acceso');
                return true;
            }
        } catch (error) {
            console.warn('‚ö† Token con formato simple, permitiendo acceso');
            return true;
        }
    }

    isValidRole(role) {
        const validRoles = ['administrador', 'residente', 'guardia', 'tecnico', 'visitante'];
        const isValid = validRoles.includes(role);
        console.log(`üîç Rol "${role}" es v√°lido:`, isValid);
        return isValid;
    }

    redirectToLogin() {
        console.log('üîí REDIRIGIENDO A LOGIN...');
        
        // Limpiar sesi√≥n
        this.clearSession();
        
        // Redirigir despu√©s de un breve delay
        setTimeout(() => {
            console.log('üöÄ Ejecutando redirecci√≥n a login...');
            window.location.href = '/login/';
        }, 1000);
    }

    redirectToDashboard(role) {
        console.log(`üéØ Redirigiendo a dashboard de: ${role}`);
        
        const dashboardMap = {
            'administrador': '/api/dashboard-admin/',
            'residente': '/api/dashboard-residente/',
            'guardia': '/api/dashboard-guardia/',
            'tecnico': '/api/dashboard-tecnico/',
            'visitante': '/api/dashboard-visitante/'
        };
        
        const dashboardUrl = dashboardMap[role] || '/api/dashboard-residente/';
        
        console.log(`üöÄ URL de destino: ${dashboardUrl}`);
        
        // ‚úÖ CORRECCI√ìN: Redirecci√≥n inmediata sin delays
        console.log('üîÄ EJECUTANDO REDIRECCI√ìN INMEDIATA...');
        window.location.href = dashboardUrl;
    }

    clearSession() {
        console.log('üßπ Limpiando sesi√≥n...');
        localStorage.removeItem('authToken');
        localStorage.removeItem('userRole');
        localStorage.removeItem('userEmail');
        localStorage.removeItem('userName');
        localStorage.removeItem('invitationCode');
        this.authChecked = false;
    }

    // M√©todo para obtener informaci√≥n del usuario actual
    getCurrentUser() {
        try {
            const token = localStorage.getItem('authToken');
            const userRole = localStorage.getItem('userRole');
            const userEmail = localStorage.getItem('userEmail');
            const userName = localStorage.getItem('userName');
            
            if (token && userRole) {
                return {
                    role: userRole,
                    email: userEmail,
                    name: userName,
                    token: token
                };
            }
            return null;
        } catch (error) {
            console.error('Error obteniendo usuario:', error);
            return null;
        }
    }

    // M√©todo para debug
    debugAuth() {
        console.log('üîç DEBUG - Estado completo:');
        console.log('  - authToken:', localStorage.getItem('authToken'));
        console.log('  - userRole:', localStorage.getItem('userRole'));
        console.log('  - userEmail:', localStorage.getItem('userEmail'));
        console.log('  - currentPath:', this.currentPath);
        console.log('  - isDashboardPage:', this.isDashboardPage());
        console.log('  - isLoginPage:', this.isLoginPage());
        console.log('  - authChecked:', this.authChecked);
    }
}

// ‚úÖ FUNCI√ìN GLOBAL MEJORADA para login exitoso
window.handleLoginSuccess = function(userData) {
    console.log('üéâ LOGIN EXITOSO - Iniciando redirecci√≥n...');
    
    if (userData && userData.token) {
        // ‚úÖ GUARDAR DATOS PRIMERO
        localStorage.setItem('authToken', userData.token);
        localStorage.setItem('userRole', userData.role);
        localStorage.setItem('userEmail', userData.email);
        if (userData.name) {
            localStorage.setItem('userName', userData.name);
        }
        
        console.log('‚úÖ Datos guardados en localStorage:');
        console.log('  - Token:', userData.token);
        console.log('  - Rol:', userData.role);
        console.log('  - Email:', userData.email);
        
        // ‚úÖ REDIRECCI√ìN INMEDIATA
        const role = userData.role || 'residente';
        console.log(`üéØ Redirigiendo a dashboard de: ${role}`);
        
        const dashboardMap = {
            'administrador': '/api/dashboard-admin/',
            'residente': '/api/dashboard-residente/',
            'guardia': '/api/dashboard-guardia/',
            'tecnico': '/api/dashboard-tecnico/',
            'visitante': '/api/dashboard-visitante/'
        };
        
        const dashboardUrl = dashboardMap[role] || '/api/dashboard-residente/';
        
        console.log(`üöÄ URL de destino: ${dashboardUrl}`);
        
        // ‚úÖ REDIRECCI√ìN DIRECTA SIN DELAY
        window.location.href = dashboardUrl;
    } else {
        console.error('‚ùå Error: userData o token no definidos');
        alert('Error en el login. Por favor intenta nuevamente.');
    }
};

// ‚úÖ NUEVA: Funci√≥n global para manejar login
window.handleLogin = async function(credentials) {
    try {
        console.log('üîê Iniciando login...', credentials);
        
        if (!window.apiService) {
            console.error('‚ùå apiService no disponible');
            return;
        }
        
        const result = await window.apiService.login(credentials);
        
        if (result.success) {
            window.handleLoginSuccess(result.user);
        } else {
            alert(result.message || 'Error en el login');
        }
    } catch (error) {
        console.error('‚ùå Error en login:', error);
        alert('Error: ' + error.message);
    }
};

// Funci√≥n global para logout
window.handleLogout = function() {
    console.log('üîí Cerrando sesi√≥n...');
    localStorage.clear();
    setTimeout(() => {
        window.location.href = '/login/';
    }, 500);
};

// Inicializar en todas las p√°ginas
document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Inicializando aplicaci√≥n...');
    console.log('üìÑ P√°gina:', window.location.pathname);
    
    // Inicializar DashboardRouter siempre
    window.dashboardRouter = new DashboardRouter();
    
    // Mostrar informaci√≥n del usuario si est√° logueado
    const userInfo = window.dashboardRouter.getCurrentUser();
    if (userInfo) {
        console.log('üë§ Usuario actual:', userInfo);
    }
    
    // ‚úÖ DEBUG: Mostrar estado completo
    window.dashboardRouter.debugAuth();
});