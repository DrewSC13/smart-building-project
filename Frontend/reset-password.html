<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BuildingPRO - Resetear Contraseña</title>
    <link rel="stylesheet" href="/css/login.css">
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>
    <div class="container">
        <div class="bg-effects">
            <div class="effect effect-1"></div>
            <div class="effect effect-2"></div>
            <div class="effect effect-3"></div>
        </div>

        <div class="logo">
            <img src="/img/Logo.png" alt="Logo Smart Building" class="logo-img">
        </div>

        <div class="login-card">
            <div class="login-header">
                <h2>Restablecer Contraseña</h2>
                <p>Ingresa tu información para crear una nueva contraseña</p>
            </div>

            <form id="resetPasswordForm">
                <input type="hidden" id="resetToken" value="">
                
                <div class="form-group">
                    <label for="identificationNumber">Número de Identificación</label>
                    <div class="input-with-icon">
                        <input type="text" id="identificationNumber" class="form-control" placeholder="Ingresa tu número de identificación" required>
                        <i class='bx bx-id-card'></i>
                    </div>
                    <small class="form-text">Este es el mismo número que usaste al registrarte (ej: número de residente, ID de guardia, etc.)</small>
                </div>

                <div class="form-group">
                    <label for="newPassword">Nueva Contraseña</label>
                    <div class="input-with-icon">
                        <input type="password" id="newPassword" class="form-control" placeholder="Ingresa tu nueva contraseña" required minlength="6">
                        <i class='bx bx-lock-alt'></i>
                        <button type="button" class="password-toggle" onclick="togglePassword('newPassword')">
                            <i class='bx bx-hide'></i>
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label for="confirmPassword">Confirmar Nueva Contraseña</label>
                    <div class="input-with-icon">
                        <input type="password" id="confirmPassword" class="form-control" placeholder="Confirma tu nueva contraseña" required minlength="6">
                        <i class='bx bx-lock-alt'></i>
                        <button type="button" class="password-toggle" onclick="togglePassword('confirmPassword')">
                            <i class='bx bx-hide'></i>
                        </button>
                    </div>
                </div>

                <button type="submit" class="btn">Restablecer Contraseña</button>

                <div class="register-link">
                    <p>¿Recordaste tu contraseña? <a href="/login/">Inicia sesión</a></p>
                </div>
            </form>
        </div>

        <div id="messageModal" class="modal">
            <div class="modal-content">
                <span class="close">&times;</span>
                <h2 id="messageTitle"></h2>
                <p id="messageText"></p>
                <button id="modalButton" class="btn" style="display: none; margin-top: 20px;">Aceptar</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const resetForm = document.getElementById('resetPasswordForm');
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            
            document.getElementById('resetToken').value = token || '';

            if (!token) {
                showMessage('Error', 'No se proporcionó un token válido. Por favor usa el enlace del email.', true);
            }

            resetForm.addEventListener('submit', async function(e) {
                e.preventDefault();

                const identificationNumber = document.getElementById('identificationNumber').value;
                const newPassword = document.getElementById('newPassword').value;
                const confirmPassword = document.getElementById('confirmPassword').value;

                if (!identificationNumber) {
                    showMessage('Error', 'Por favor ingresa tu número de identificación.');
                    return;
                }

                if (newPassword.length < 6) {
                    showMessage('Error', 'La contraseña debe tener al menos 6 caracteres.');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showMessage('Error', 'Las contraseñas no coinciden.');
                    return;
                }

                await performPasswordReset(token, identificationNumber, newPassword, confirmPassword);
            });

            function togglePassword(inputId) {
                const input = document.getElementById(inputId);
                const type = input.getAttribute('type') === 'password' ? 'text' : 'password';
                input.setAttribute('type', type);

                const icon = input.parentNode.querySelector('.password-toggle i');
                icon.classList.toggle('bx-hide');
                icon.classList.toggle('bx-show');
            }

            function showMessage(title, text, showButton = false) {
                document.getElementById('messageTitle').textContent = title;
                document.getElementById('messageText').textContent = text;
                const modalButton = document.getElementById('modalButton');
                modalButton.style.display = showButton ? 'block' : 'none';
                
                if (showButton) {
                    modalButton.onclick = function() {
                        window.location.href = '/login/';  // Corregido: /login/ en lugar de /login.html
                    };
                }
                
                document.getElementById('messageModal').style.display = 'flex';
            }

            async function performPasswordReset(token, identificationNumber, newPassword, confirmPassword) {
                const submitBtn = resetForm.querySelector('button[type="submit"]');
                const originalText = submitBtn.textContent;
                submitBtn.textContent = 'Procesando...';
                submitBtn.disabled = true;

                try {
                    const response = await fetch('/api/password-reset-confirm/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({
                            token: token,
                            identification_number: identificationNumber,
                            new_password: newPassword,
                            confirm_password: confirmPassword
                        })
                    });

                    const data = await response.json();

                    if (response.ok) {
                        showMessage('Éxito', data.message, true);
                    } else {
                        showMessage('Error', data.error || 'Error al restablecer la contraseña');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    showMessage('Error', 'Error de conexión con el servidor');
                } finally {
                    submitBtn.textContent = 'Restablecer Contraseña';
                    submitBtn.disabled = false;
                }
            }

            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }

            document.querySelector('.close').addEventListener('click', function() {
                document.getElementById('messageModal').style.display = 'none';
            });

            window.addEventListener('click', function(e) {
                if (e.target === document.getElementById('messageModal')) {
                    document.getElementById('messageModal').style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>
